<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Metin ‚Äî Sd√≠len√Ω √ökoln√≠ƒçek</title>
<link rel="stylesheet" href="style.css">

</head>
<body>

  <div class="sidebar">
    <div class="image-box" id="imageBox">Klikni na tlaƒç√≠tko n√≠≈æe pro p≈ôid√°n√≠ obr√°zku</div>
    <label for="imgInput" class="upload-label">üì∏ P≈ôidat obr√°zek</label>
    <input type="file" id="imgInput" accept="image/*">
  </div>

  <div class="main">
    <!-- P≈ôihl√°≈°en√≠ jm√©na -->
    <div class="wrap" id="loginWrap">
      <header><h1>P≈ôihla≈° se</h1></header>
      <main>
        <input type="text" id="username" placeholder="Zadej sv√© jm√©no">
        <button class="btn" id="loginBtn">P≈ôihl√°sit</button>
      </main>
    </div>

    <div id="taskWrap" style="display:none;">
      <!-- P≈Øvodn√≠ √∫koln√≠ƒçky -->
      <div class="wrap level-wrap" id="level0_75">
        <header><h2>Level 0-75</h2></header>
        <main>
          <div class="new-task">
            <input type="text" placeholder="P≈ôidat √∫kol..." class="taskInput">
            <button class="btn addBtn">P≈ôidat</button>
          </div>
          <div class="stats"><span class="total">√ökol≈Ø: 0</span> | <span class="done">Splnƒõno: 0</span></div>
          <ul class="tasks"></ul>
        </main>
      </div>
      <div class="wrap level-wrap" id="level75_90">
        <header><h2>Level 75-90</h2></header>
        <main>
          <div class="new-task">
            <input type="text" placeholder="P≈ôidat √∫kol..." class="taskInput">
            <button class="btn addBtn">P≈ôidat</button>
          </div>
          <div class="stats"><span class="total">√ökol≈Ø: 0</span> | <span class="done">Splnƒõno: 0</span></div>
          <ul class="tasks"></ul>
        </main>
      </div>
      <div class="wrap level-wrap" id="level90_105">
        <header><h2>Level 90-105</h2></header>
        <main>
          <div class="new-task">
            <input type="text" placeholder="P≈ôidat √∫kol..." class="taskInput">
            <button class="btn addBtn">P≈ôidat</button>
          </div>
          <div class="stats"><span class="total">√ökol≈Ø: 0</span> | <span class="done">Splnƒõno: 0</span></div>
          <ul class="tasks"></ul>
        </main>
      </div>
      <div class="wrap level-wrap" id="level105_120">
        <header><h2>Level 105-120</h2></header>
        <main>
          <div class="new-task">
            <input type="text" placeholder="P≈ôidat √∫kol..." class="taskInput">
            <button class="btn addBtn">P≈ôidat</button>
          </div>
          <div class="stats"><span class="total">√ökol≈Ø: 0</span> | <span class="done">Splnƒõno: 0</span></div>
          <ul class="tasks"></ul>
        </main>
      </div>
    </div>
  </div>

 <!-- Prav√° mapa -->
<div class="wrap" id="mapWrap">
  <header>
    <h2>Mapa</h2>
    <button class="btn" id="clearDotsBtn">Smazat v≈°echny punt√≠ky</button>
  </header>
  <main>
    <div id="mapBox">Klikni pro p≈ôid√°n√≠ punt√≠ku</div>
    <ul id="dotLog"></ul>
    <label for="mapInput" class="upload-label">üåÑ Nahraj mapu</label>
    <input type="file" id="mapInput" accept="image/*">
  </main>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC3PaMUuGwWJIS6bPIMBTcNGoVoOCRKbXE",
  authDomain: "origins-72614.firebaseapp.com",
  databaseURL: "https://origins-72614-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "origins-72614",
  storageBucket: "origins-72614.appspot.com",
  messagingSenderId: "75762974683",
  appId: "1:75762974683:web:c3932393231b4526c6f1fe",
  measurementId: "G-SLWP5G89BP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
let currentUser = "";

// P≈ôihl√°≈°en√≠
document.getElementById("loginBtn").addEventListener("click", () => {
  const name = document.getElementById("username").value.trim();
  if(!name) return alert("Zadej sv√© jm√©no!");
  currentUser = name;
  localStorage.setItem("metinUserName", currentUser);
  document.getElementById("loginWrap").style.display = "none";
  document.getElementById("taskWrap").style.display = "block";
  initLevelSections();
  initMap();
});

window.addEventListener("load", () => {
  const savedName = localStorage.getItem("metinUserName");
  if(savedName){
    currentUser = savedName;
    document.getElementById("loginWrap").style.display = "none";
    document.getElementById("taskWrap").style.display = "block";
    initLevelSections();
    initMap();
  }
});

// P≈Øvodn√≠ obr√°zek
const imgInput = document.getElementById("imgInput");
const imageBox = document.getElementById("imageBox");
const imgRef = ref(db, "sharedImage");
onValue(imgRef, snapshot => {
  const dataUrl = snapshot.val();
  if(dataUrl) imageBox.innerHTML = `<img src="${dataUrl}" alt="Sd√≠len√Ω obr√°zek">`;
});
imgInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => set(imgRef, ev.target.result);
  reader.readAsDataURL(file);
});

// √ökoln√≠ƒçek
function initLevelSections(){
  const levels = ["level0_75","level75_90","level90_105","level105_120"];
  levels.forEach(lvl=>{
    const section=document.getElementById(lvl);
    const input=section.querySelector(".taskInput");
    const btn=section.querySelector(".addBtn");
    const list=section.querySelector(".tasks");
    const totalEl=section.querySelector(".total");
    const doneEl=section.querySelector(".done");

    btn.addEventListener("click",()=>{
      const title=input.value.trim();
      if(!title) return;
      const taskRef=push(ref(db,"tasks"));
      set(taskRef,{title,level:lvl,author:currentUser});
      input.value="";
    });

    onValue(ref(db,"tasks"), snapshot=>{
      list.innerHTML="";
      let total=0, doneCount=0;
      snapshot.forEach(child=>{
        const task=child.val();
        if(task.level!==lvl) return;
        const li=document.createElement("li");
        const userDone=task.doneUsers||{};
        const isDone=userDone[currentUser]||false;
        const doneUsersList=Object.keys(userDone);
        const doneCountNum=doneUsersList.length;
        li.className="task"+(isDone?" done":"");
        li.innerHTML=`<div style="display:flex;gap:10px;align-items:center;">
          <div class="chk ${isDone?"checked":""}">${isDone?"‚úì":""}</div>
          <div class="title">${task.title}<br><small>Autor: ${task.author}</small></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="done-badge tooltip-container">${doneCountNum}<span class="tooltip">${doneCountNum>0?doneUsersList.join(', '):'Nikdo zat√≠m ne'}</span></div>
          <button class="del-btn">‚úñ</button>
        </div>`;
        li.querySelector(".chk").addEventListener("click", ()=>{
          const updates={};
          updates[`tasks/${child.key}/doneUsers/${currentUser}`]=!isDone;
          update(ref(db), updates);
        });
        li.querySelector(".del-btn").addEventListener("click", ()=> remove(ref(db,"tasks/"+child.key)));
        list.appendChild(li);
        total++; doneCount+=doneCountNum;
      });
      totalEl.textContent="√ökol≈Ø: "+total;
      doneEl.textContent="Splnƒõno: "+doneCount;
    });
  });
}

// Mapa s punt√≠ky
function initMap(){
  const mapBox = document.getElementById("mapBox");
  const mapInput = document.getElementById("mapInput");
  const clearBtn = document.getElementById("clearDotsBtn");
  const logList = document.getElementById("dotLog");

  const mapRef = ref(db,"sharedMap");
  const dotsRef = ref(db,"dots");

  // Naƒçten√≠ mapy
  onValue(mapRef, snap=>{
    const url = snap.val();
    if(url) mapBox.innerHTML = `<img src="${url}" alt="Mapa">`;
  });

  mapInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => set(mapRef, ev.target.result);
    reader.readAsDataURL(file);
  });

  // P≈ôid√°n√≠ punt√≠ku
  mapBox.addEventListener("click", e=>{
    if(!currentUser) return alert("P≈ôihlas se!");
    const rect = mapBox.getBoundingClientRect();
    const x = ((e.clientX-rect.left)/rect.width).toFixed(3);
    const y = ((e.clientY-rect.top)/rect.height).toFixed(3);
    const dotRef = push(dotsRef);
    set(dotRef,{x,y,author:currentUser});
  });

  // Naƒçten√≠ punt√≠k≈Ø
  onValue(dotsRef, snap=>{
    mapBox.querySelectorAll(".dot").forEach(d=>d.remove());
    logList.innerHTML="";
    snap.forEach(child=>{
      const d = child.val();
      const dotEl = document.createElement("div");
      dotEl.className="dot";
      dotEl.style.left=(d.x*100)+"%";
      dotEl.style.top=(d.y*100)+"%";
      mapBox.appendChild(dotEl);

      const li = document.createElement("li");
      li.textContent = `${d.author} (${(d.x*100).toFixed(1)}%, ${(d.y*100).toFixed(1)}%)`;
      logList.appendChild(li);

      // klik = sma≈æe punt√≠k
      dotEl.addEventListener("click", (ev)=>{
        ev.stopPropagation(); 
        remove(ref(db,"dots/"+child.key));
      });
      li.addEventListener("click", ()=> remove(ref(db,"dots/"+child.key)));
    });
  });

  // Smazat v≈°echny
  clearBtn.addEventListener("click", ()=>{
    if(confirm("Opravdu smazat v≈°echny punt√≠ky?")) remove(dotsRef);
  });
}
</script>
</body>
</html>
